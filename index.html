
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calculadora de vencimiento</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos mínimos; puedes reemplazar por tu styles.css si prefieres */
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { margin-bottom: 8px; }
    .muted { color:#666; }
    .card { padding:16px; border:1px solid #ddd; border-radius:8px; max-width:900px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:768px){ .row { grid-template-columns:1fr; } }
    input, textarea, select { width:100%; padding:10px; font-size:1rem; border:1px solid #ccc; border-radius:6px; }
    input:focus, textarea:focus, select:focus { outline: 2px solid #1976d2; border-color:#1976d2; }
    .btn { padding:8px 12px; border:0; border-radius:6px; background:#1976d2; color:#fff; cursor:pointer; }
    .btn.secondary { background:#777; }
    .result { background:#f6f8fa; border:1px solid #e0e0e0; padding:12px; border-radius:6px; margin-top:12px; }
    details { margin-top:12px; }
    .tools { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .error { color:#b00020; }
    code { background:#eee; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Calculadora de vencimiento (2 campos)</h1>
  <p class="muted">
    Ingresa la <b>fecha/hora</b> de creación y las <b>horas de vida</b> del ticket. Jornada por defecto: <b>Lun–Vie, 08:00–19:00</b> (Lima, UTC−5).
  </p>

  <div class="card" role="region" aria-label="Calculadora de vencimiento">
    <!-- 1) Entradas principales -->
    <div class="row">
      <div>
        <label for="dt"><b>Fecha/hora de creación</b></label>
        <div style="display:flex; gap:8px;">
          <input id="dt" type="text" placeholder="Ej: 2025-12-29 08:56:13" aria-describedby="dtHelp" style="flex:1;">
          <!-- Botón NUEVO: Ahora (Lima) -->
          <button id="nowBtn" type="button" class="btn secondary" title="Usar ahora (Lima)">Ahora</button>
        </div>
        <small id="dtHelp" class="muted">
          Formatos admitidos: <code>YYYY-MM-DD HH:mm[:ss]</code>, <code>YYYY/MM/DD HH:mm[:ss]</code>, <code>DD/MM/YYYY HH:mm[:ss]</code>, o <code>YYYY-MM-DDTHH:mm</code>.
        </small>
      </div>
      <div>
        <label for="hours"><b>Horas de vida del ticket</b></label>
        <input id="hours" type="number" min="0" step="0.25" placeholder="48" aria-describedby="hHelp">
        <small id="hHelp" class="muted">Usa decimales si necesitas (ej. <code>12.5</code>).</small>
      </div>
    </div>

    <!-- 2) Acciones -->
    <div style="margin-top:16px; display:flex; gap:8px; justify-content:center;">
      <button id="calcBtn" class="btn">Calcular vencimiento</button>
      <button id="resetBtn" class="btn secondary">Restablecer ejemplo</button>
    </div>

    <!-- 3) Resultado -->
    <div id="result" class="result" style="display:none;" aria-live="polite"></div>
    <div id="tools" class="tools" style="display:none;">
      <button id="copyBtn" class="btn secondary">Copiar</button>
    </div>

    <!-- 4) Detalle del cálculo -->
    <details>
      <summary><b>Detalle del cálculo</b> (tramos acumulados)</summary>
      <pre id="debugLog"></pre>
    </details>

    <!-- 5) Configuración avanzada -->
    <details>
      <summary><b>Configuración avanzada</b> (horario, días hábiles, feriados, pausa)</summary>
      <div class="row" style="margin-top:8px;">
        <div>
          <label for="workStart">Inicio de jornada</label>
          <input id="workStart" type="time" value="08:00">
        </div>
        <div>
          <label for="workEnd">Fin de jornada</label>
          <input id="workEnd" type="time" value="19:00">
        </div>
        <div>
          <label>Días hábiles</label><br/>
          <small class="muted">Lun–Vie por defecto; incluye Sáb/Dom si aplica.</small>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <label><input type="checkbox" class="wd" value="1" checked> Lun</label>
            <label><input type="checkbox" class="wd" value="2" checked> Mar</label>
            <label><input type="checkbox" class="wd" value="3" checked> Mié</label>
            <label><input type="checkbox" class="wd" value="4" checked> Jue</label>
            <label><input type="checkbox" class="wd" value="5" checked> Vie</label>
            <label><input type="checkbox" class="wd" value="6"> Sáb</label>
            <label><input type="checkbox" class="wd" value="0"> Dom</label>
          </div>
        </div>
        <div>
          <label><input type="checkbox" id="useBreak"> Considerar pausa (ej. 13:00–14:00)</label>
          <div class="row" style="margin-top:6px;">
            <div>
              <label for="breakStart">Inicio de pausa</label>
              <input id="breakStart" type="time" value="13:00">
            </div>
            <div>
              <label for="breakEnd">Fin de pausa</label>
              <input id="breakEnd" type="time" value="14:00">
            </div>
          </div>
        </div>
        <div style="grid-column:1 / -1;">
          <label for="holidays">Feriados (YYYY-MM-DD, uno por línea)</label>
          <textarea id="holidays" rows="6" placeholder="2026-01-01&#10;2025-12-25"></textarea>
        </div>
      </div>
    </details>
  </div>

  <script>
    // ====== Utilidades de fecha/hora ======
    const pad2 = (n)=> String(n).padStart(2,'0');
    const fmtYMDHMS = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    const fmtPeru   = (d)=> `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    const timeToMinutes = (t)=> { const [h,m] = t.split(':').map(Number); return h*60 + m; };

    // ====== Parser robusto (acepta varios formatos) ======
    // "YYYY-MM-DD HH:mm[:ss]", "YYYY/MM/DD HH:mm[:ss]", "DD/MM/YYYY HH:mm[:ss]", y "YYYY-MM-DDTHH:mm"
    function parseFlexibleDateTime(input) {
      if (!input) return null;

      // Normaliza espacios (incluye non-breaking space) y colapsa múltiples
      let s = String(input)
        .replace(/\u00A0/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();

      // 1) ISO/espacio: YYYY-MM-DD[ T]HH:mm[:ss]
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})T\s:(\d{2})(?::(\d{2}))?/);
      if (m) {
        const Y = +m[1], M = +m[2] - 1, D = +m[3], h = +m[4], mm = +m[5], ss = +(m[6] || 0);
        return new Date(Y, M, D, h, mm, ss, 0);
      }

      // 2) YYYY/MM/DD HH:mm[:ss] o YYYY-MM-DD HH:mm[:ss]
      m = s.match(/^(\d{4})\/-\/-\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (m) {
        const Y = +m[1], M = +m[2] - 1, D = +m[3], h = +m[4], mm = +m[5], ss = +(m[6] || 0);
        return new Date(Y, M, D, h, mm, ss, 0);
      }

      // 3) DD/MM/YYYY HH:mm[:ss]
      m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (m) {
        const D = +m[1], M = +m[2] - 1, Y = +m[3], h = +m[4], mm = +m[5], ss = +(m[6] || 0);
        return new Date(Y, M, D, h, mm, ss, 0);
      }

      // 4) Fallback exacto: "YYYY-MM-DD HH:mm:ss"
      if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(s)) {
        const [datePart, timePart] = s.split(' ');
        const [Y, M, D] = datePart.split('-').map(Number);
        const [h, mm, ss] = timePart.split(':').map(Number);
        return new Date(Y, M - 1, D, h, mm, ss, 0);
      }

      return null;
    }

    // ====== “Ahora” en Lima (America/Lima) ======
    function nowInTimeZoneComponents(tz = 'America/Lima') {
      const fmt = new Intl.DateTimeFormat('es-PE', {
        timeZone: tz,
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
      const parts = fmt.formatToParts(new Date());
      const get = (type) => parts.find(p => p.type === type)?.value;
      const Y = get('year');
      const M = get('month');
      const D = get('day');
      const h = get('hour');
      const m = get('minute');
      const s = get('second');
      return { Y, M, D, h, m, s };
    }
    function formatYMDHMS({ Y, M, D, h, m, s }) {
      return `${Y}-${M}-${D} ${h}:${m}:${s}`;
    }

    // ====== Calendario laboral ======
    function isWorkingDay(date, workDaysSet, holidaysSet) {
      const dow = date.getDay(); // 0=Dom, 1=Lun...
      const ymd = `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;
      if (!workDaysSet.has(dow)) return false;
      if (holidaysSet.has(ymd)) return false;
      return true;
    }
    function advanceToNextWorkingDay(date, workDaysSet, holidaysSet) {
      while (!isWorkingDay(date, workDaysSet, holidaysSet)) date.setDate(date.getDate()+1);
    }
    function clampToWorkWindow(date, wsMin, weMin, workDaysSet, holidaysSet) {
      const minutes = date.getHours()*60 + date.getMinutes();
      if (!isWorkingDay(date, workDaysSet, holidaysSet) || minutes < wsMin || minutes >= weMin) {
        do { date.setDate(date.getDate() + (!isWorkingDay(date, workDaysSet, holidaysSet) || minutes >= weMin ? 1 : 0)); }
        while (!isWorkingDay(date, workDaysSet, holidaysSet));
        date.setHours(Math.floor(wsMin/60), wsMin%60, 0, 0);
      }
    }

    // Pausa opcional por segmentos
    function getDaySegments(wsMin, weMin, useBreak, bStartMin, bEndMin) {
      if (!useBreak) return [[wsMin, weMin]];
      const bStart = Math.max(wsMin, Math.min(bStartMin, weMin));
      const bEnd   = Math.max(wsMin, Math.min(bEndMin, weMin));
      if (bEnd <= bStart) return [[wsMin, weMin]];
      const segs = [];
      if (bStart > wsMin) segs.push([wsMin, bStart]);
      if (bEnd < weMin) segs.push([bEnd, weMin]);
      return segs.length ? segs : [[wsMin, weMin]];
    }
    function findSegment(segs, minutesNow) {
      for (let i=0;i<segs.length;i++){
        const [s,e] = segs[i];
        if (minutesNow < e) return [i, Math.max(minutesNow, s)];
      }
      return [-1,null];
    }

    // Suma de horas laborales
    function addWorkingHours(startDate, hoursToAdd, workStart, workEnd, workDaysArray, holidaysArray, useBreak, breakStart, breakEnd, debug=false) {
      const debugLines = [];
      const wsMin = timeToMinutes(workStart);
      const weMin = timeToMinutes(workEnd);
      const bStartMin = timeToMinutes(breakStart);
      const bEndMin   = timeToMinutes(breakEnd);
      if (weMin <= wsMin) throw new Error("Fin de jornada debe ser posterior al inicio.");
      if (hoursToAdd < 0) throw new Error("Las horas a sumar deben ser ≥ 0.");
      if (!workDaysArray.length) throw new Error("Selecciona al menos un día hábil.");

      const workDaysSet = new Set(workDaysArray.map(Number));
      const holidaysSet = new Set(holidaysArray.map(s=>s.trim()).filter(Boolean));

      const current = new Date(startDate.getTime());
      advanceToNextWorkingDay(current, workDaysSet, holidaysSet);
      clampToWorkWindow(current, wsMin, weMin, workDaysSet, holidaysSet);

      let remaining = Math.round(hoursToAdd * 60);

      while (remaining > 0) {
        if (!isWorkingDay(current, workDaysSet, holidaysSet)) {
          debug && debugLines.push(`No hábil/feriado: ${fmtYMDHMS(current)} → se avanza`);
          advanceToNextWorkingDay(current, workDaysSet, holidaysSet);
          current.setHours(Math.floor(wsMin/60), wsMin%60, 0, 0);
          continue;
        }
        const minutesNow = current.getHours()*60 + current.getMinutes();
        const segsBase = getDaySegments(wsMin, weMin, useBreak, bStartMin, bEndMin);
        const [segIndex, startInSeg] = findSegment(segsBase, minutesNow);

        if (segIndex === -1) {
          current.setDate(current.getDate()+1);
          advanceToNextWorkingDay(current, workDaysSet, holidaysSet);
          current.setHours(Math.floor(wsMin/60), wsMin%60, 0, 0);
          continue;
        }

        const [segStart, segEnd] = segsBase[segIndex];
        const avail = segEnd - startInSeg;
        const chunk = Math.min(remaining, avail);

        const before = new Date(current.getTime());
        current.setHours(Math.floor(startInSeg/60), startInSeg%60, 0, 0);
        current.setMinutes(current.getMinutes() + chunk);
        remaining -= chunk;
        debug && debugLines.push(`+${chunk} min: ${fmtYMDHMS(before)} → ${fmtYMDHMS(current)} (restan ${remaining} min)`);

        if (remaining > 0 && (current.getHours()*60 + current.getMinutes()) >= segEnd) {
          const nextSegIndex = segIndex + 1;
          if (nextSegIndex < segsBase.length) {
            const [nsStart] = segsBase[nextSegIndex];
            current.setHours(Math.floor(nsStart/60), nsStart%60, 0, 0);
          } else {
            current.setDate(current.getDate()+1);
            advanceToNextWorkingDay(current, workDaysSet, holidaysSet);
            current.setHours(Math.floor(wsMin/60), wsMin%60, 0, 0);
          }
        }
      }
      return { end: current, debug: debugLines.join('\n') };
    }

    // ====== UI ======
    const dtEl      = document.getElementById('dt');
    const hoursEl   = document.getElementById('hours');
    const calcBtn   = document.getElementById('calcBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const nowBtn    = document.getElementById('nowBtn');
    const resultEl  = document.getElementById('result');
    const toolsEl   = document.getElementById('tools');
    const debugEl   = document.getElementById('debugLog');

    const workStartEl = document.getElementById('workStart');
    const workEndEl   = document.getElementById('workEnd');
    const holidaysEl  = document.getElementById('holidays');
    const useBreakEl  = document.getElementById('useBreak');
    const breakStartEl= document.getElementById('breakStart');
    const breakEndEl  = document.getElementById('breakEnd');
    const wdChecks    = Array.from(document.querySelectorAll('.wd'));

    function getSelectedWorkDays(){ return wdChecks.filter(c => c.checked).map(c => Number(c.value)); }
    function parseHolidaysTextarea(){ return holidaysEl.value.split('\n').map(s => s.trim()).filter(Boolean); }

    function calculate() {
      try {
        // Normaliza posibles caracteres invisibles en la fecha
        const dateStr = (dtEl.value || '').replace(/\u00A0/g, ' ').trim();
        const hoursStr = (hoursEl.value || '').trim();

        const startDate = parseFlexibleDateTime(dateStr);
        if (!startDate) throw new Error("Fecha/hora inválida. Usa, por ejemplo: 2025-12-29 08:56:13");

        const hours = parseFloat(hoursStr);
        if (!Number.isFinite(hours) || hours < 0) throw new Error("Horas inválidas. Ingresa un número ≥ 0.");

        const workStart = workStartEl.value || "08:00";
        const workEnd   = workEndEl.value   || "19:00";
        const workDays  = getSelectedWorkDays();
        const holidays  = parseHolidaysTextarea();
        const useBreak  = !!useBreakEl.checked;
        const breakStart= breakStartEl.value || "13:00";
        const breakEnd  = breakEndEl.value   || "14:00";

        const { end, debug } = addWorkingHours(
          startDate, hours, workStart, workEnd, workDays, holidays, useBreak, breakStart, breakEnd, true
        );

        resultEl.style.display = 'block';
        toolsEl.style.display = 'flex';
        resultEl.innerHTML = `
          <div><b>Vence:</b> ${fmtPeru(end)} <small>(${fmtYMDHMS(end)})</small></div>
          <div><small>Inicio: ${fmtPeru(startDate)} | Horas: ${hours}</small></div>
          <div><small>Config: ${workStart}–${workEnd}${useBreak ? ` (pausa ${breakStart}–${breakEnd})` : ''}, días hábiles: ${workDays.join(', ') || '(ninguno)'}, feriados: ${holidays.length}</small></div>
        `;
        debugEl.textContent = debug;
      } catch (err) {
        resultEl.style.display = 'block';
        toolsEl.style.display = 'none';
        resultEl.innerHTML = `<span class="error"><b>Error:</b> ${err.message}</span>`;
        debugEl.textContent = '';
      }
    }

    async function copyResult() {
      const text = resultEl.textContent.trim();
      try { await navigator.clipboard.writeText(text); this.textContent='Copiado ✓'; setTimeout(()=> this.textContent='Copiar', 1200); } catch {}
    }

    function resetExample() {
      dtEl.value    = "2025-12-29 08:56:13";
      hoursEl.value = "48";
      holidaysEl.value = [
        // Ajusta a tu calendario corporativo/país
        "2026-01-01","2025-12-25","2025-12-08","2025-11-01","2025-10-08",
        "2025-08-30","2025-07-29","2025-07-28","2025-06-29","2025-05-01",
        "2025-04-18","2025-04-17","2025-01-01"
      ].join('\n');
      wdChecks.forEach(c => c.checked = ['1','2','3','4','5'].includes(c.value)); // Lun–Vie
      useBreakEl.checked = false; // desactivado por defecto (actívalo si quieres contar pausa)
      resultEl.style.display = 'none';
      toolsEl.style.display  = 'none';
      debugEl.textContent = '';
    }

    // ====== Botón “Ahora” (Lima) ======
    function setNowLimaAndMaybeCalculate(autoCalc = true) {
      const comps = nowInTimeZoneComponents('America/Lima');
      const stamp = formatYMDHMS(comps);
      dtEl.value = stamp;
      if (autoCalc) {
        if (!hoursEl.value || !hoursEl.value.trim()) hoursEl.value = '48';
        calculate();
      }
    }

    document.getElementById('copyBtn').addEventListener('click', copyResult);
    calcBtn.addEventListener('click', calculate);
    resetBtn.addEventListener('click', resetExample);
    nowBtn.addEventListener('click', () => setNowLimaAndMaybeCalculate(true));

    // Inicializa ejemplo
    resetExample();
  </script>
</body>
</html>

